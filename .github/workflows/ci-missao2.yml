
name: CI Missao 2 - Multi-OS + Segurança (Gate)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read

jobs:
  # -----------------------------
  # 1) Hello World - Windows
  # -----------------------------
  hello_windows:
    name: Hello Windows
    runs-on: windows-latest
    steps:
      - name: Mensagem
        run: echo "Hello from Windows"

  # -----------------------------
  # 2) Hello World - Linux
  # -----------------------------
  hello_linux:
    name: Hello Linux
    runs-on: ubuntu-latest
    steps:
      - name: Mensagem
        run: echo "Hello from Linux"

  # -----------------------------
  # 3) Segurança - ZAP (Linux)
  #    - Gate ativado (sem -I)
  # -----------------------------
  security_linux_zap:
    name: Segurança - ZAP (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Verificar Docker
        run: docker --version

      - name: Rodar ZAP Baseline (DAST passivo)
        run: |
          docker pull ghcr.io/zaproxy/zaproxy:stable
          docker run --rm -v "$(pwd)":/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t "https://httpbin.org" \
            -r zap-report-linux.html -x zap-report-linux.xml -J zap-report-linux.json \
            -m 1
      # Sem -I => se houver WARN/FAIL, o script retorna código != 0
      # Códigos do baseline: 0 OK | 1 FAIL | 2 WARN | 3 erro operacional

      - name: Publicar Relatórios (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: report-zap-linux
          path: |
            zap-report-linux.html
            zap-report-linux.xml
            zap-report-linux.json

  # -----------------------------
  # 4) Segurança - ZAP (Windows)
  #    - Gate ativado (sem -I)
  # -----------------------------
  security_windows_zap:
    name: Segurança - ZAP (Windows)
    runs-on: windows-latest
    steps:
      - name: Verificar Docker (Windows)
        shell: powershell
        run: docker --version

      # Vamos usar 'bash' para manter a mesma sintaxe do Linux:
      - name: Rodar ZAP Baseline (DAST passivo)
        shell: bash
        run: |
          docker pull ghcr.io/zaproxy/zaproxy:stable
          docker run --rm -v "$(pwd)":/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t "https://httpbin.org" \
            -r zap-report-windows.html -x zap-report-windows.xml -J zap-report-windows.json \
            -m 1

      - name: Publicar Relatórios (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: report-zap-windows
          path: |
            zap-report-windows.html
            zap-report-windows.xml
            zap-report-windows.json
``
